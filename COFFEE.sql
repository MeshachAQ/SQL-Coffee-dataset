SELECT * FROM customers$

SELECT * FROM orders$

SELECT * FROM products$

SELECT * FROM customers$

--ALRIGHT, LET'S START BY CLEANING THE FIRST TABLE THROUGH TO THE THIRD ONE
--WE START BY DROPPING THIS COLUMN WE SHAN'T BE WORKING WITH

ALTER TABLE customers$
DROP COLUMN POSTCODE

--HERE, WE WANNA EXPAND THE CUSTOMER NAME INTO FIRSTNAME AND SURNAME
--USING PARSENAME AND REPLACE

SELECT [CUSTOMER NAME], PARSENAME(REPLACE([CUSTOMER NAME], ' ', '.'), 1) AS Sur_Name,
 PARSENAME(REPLACE([CUSTOMER NAME], ' ', '.'), 2) AS First_Name_Name FROM customers$

ALTER TABLE customers$
ADD First_Name VARCHAR(100)

UPDATE customers$
SET First_Name = PARSENAME(REPLACE([CUSTOMER NAME], ' ', '.'), 2)

ALTER TABLE customers$
ADD Sur_Name VARCHAR(100)

UPDATE customers$
SET Sur_Name = PARSENAME(REPLACE([CUSTOMER NAME], ' ', '.'), 1)

--WE WANNA DROP THIS COLUMN NOW
ALTER TABLE customers$
DROP COLUMN [CUSTOMER NAME]

--NOW, WE WANT TO REMOVE ALL NULL VALUES FROM OUR EMAIL AND TELEPHONE COLUMN JUST SO WE HAVE A DATASET
--WITH NO NULL VALUES

DELETE FROM customers$
WHERE EMAIL IS NULL

DELETE FROM customers$
WHERE [PHONE NUMBER] IS NULL



--WE START CLEANING UP THIS SECOND TABLE

SELECT * FROM orders$


--FIRSTLY, WE LOOK AT DROPPING BOTH THESE COLUMNS. COULD HAVE DONE ALL AT ONCE BUT...YH
ALTER TABLE orders$
DROP COLUMN YEAR

ALTER TABLE orders$
DROP COLUMN [ORDER DATE]


--NOW FOR THE THIRD TABLE IN OUR DATASET
SELECT * FROM products$


--HERE WE WANNA DO SOME STANDARDIZATION MAKING THE VALUES UNDERSTANDABLE
SELECT [COFFEE TYPE],
CASE
WHEN [COFFEE TYPE] = 'ARA' THEN 'Arabica'
WHEN [COFFEE TYPE] = 'EXC' THEN 'Exceta'
WHEN [COFFEE TYPE] = 'LIB' THEN 'Liberica'
WHEN [COFFEE TYPE] = 'ROB' THEN 'Robrica'
END AS Coffee_Type FROM products$

SELECT [ROAST TYPE],
CASE
WHEN [ROAST TYPE] = 'L' THEN 'Light'
WHEN [ROAST TYPE] = 'M' THEN 'Medium'
WHEN [ROAST TYPE] = 'D' THEN 'Dark'
END AS Roast_Type FROM products$

ALTER TABLE products$
ADD Coffee_Type VARCHAR(100)

UPDATE products$
SET Coffee_Type = CASE
WHEN [COFFEE TYPE] = 'ARA' THEN 'Arabica'
WHEN [COFFEE TYPE] = 'EXC' THEN 'Exceta'
WHEN [COFFEE TYPE] = 'LIB' THEN 'Liberica'
WHEN [COFFEE TYPE] = 'ROB' THEN 'Robrica'
END

ALTER TABLE products$
ADD Roast_Type VARCHAR(100)

UPDATE products$
SET Roast_Type = CASE
WHEN [ROAST TYPE] = 'L' THEN 'Light'
WHEN [ROAST TYPE] = 'M' THEN 'Medium'
WHEN [ROAST TYPE] = 'D' THEN 'Dark'
END


--AND THEN, WE LOOK AT DROPPING THE COLUMNS BELOW
ALTER TABLE products$
DROP COLUMN [COFFEE TYPE], [ROAST TYPE]



--OUR FINAL CLEANED TABLES NOW LOOK LIKE THIS
SELECT * FROM customers$

SELECT * FROM orders$

SELECT * FROM products$



--NOW, WE WANNA ANSWER SOME BUSINESS QUESTIONS
--1. CALCULATE THE TOTAL AND AVERAGE REVENUE
SELECT SUM(QUANTITY * [UNIT PRICE]) REV, AVG(QUANTITY * [UNIT PRICE]) AVG FROM orders$ O INNER JOIN products$ P ON
O.[Product ID] = P.[Product ID]

--2. WHAT IS THE TOTAL AND AVERAGE REVENUE BY COUNTRY?
SELECT C.COUNTRY, SUM(QUANTITY * [UNIT PRICE]) REV, AVG(QUANTITY * [UNIT PRICE]) AVG FROM orders$ O INNER JOIN products$ P ON
O.[Product ID] = P.[Product ID] INNER JOIN customers$ C ON C.[Customer ID] = O.[Customer ID]
GROUP BY C.Country

--3. WHAT IS THE TOTAL AND AVERAGE REV BY CITY
SELECT C.City, SUM(QUANTITY * [UNIT PRICE]) REV, AVG(QUANTITY * [UNIT PRICE]) AVG FROM orders$ O INNER JOIN products$ P ON
O.[Product ID] = P.[Product ID] INNER JOIN customers$ C ON C.[Customer ID] = O.[Customer ID]
GROUP BY C.City

--4. FIND THE TOP 5 MOST CONTRIBUTED CUSTOMER DETAILS
SELECT TOP 5 SUM(QUANTITY * [UNIT PRICE]) Total_Amount, First_Name, Sur_Name, [Phone Number],
Country, City FROM customers$ C INNER JOIN orders$ O ON C.[CUSTOMER ID] = O.[CUSTOMER ID]
INNER JOIN products$ P ON O.[PRODUCT ID] = P.[PRODUCT ID]
GROUP BY First_Name, Sur_Name, [Phone Number], Country, City
ORDER BY Total_Amount DESC

--5. FIND THE TOTAL ORDERS BY YEAR
SELECT YEAR(DATE), COUNT([ORDER ID]) CNT FROM orders$
GROUP BY YEAR(DATE)
ORDER BY CNT ASC
--6. FIND THE TOTAL REVENUE BY MONTH
SELECT MONTH(DATE) AS Mth, COUNT([ORDER ID]) CNT FROM orders$
GROUP BY MONTH(DATE)
ORDER BY CNT ASC

--7. FIND THE TOTAL REVENUE AND ORDERS BY DAY
SELECT DAY(DATE) AS DAY, COUNT([ORDER ID]) CNT FROM orders$
GROUP BY DAY(DATE)
ORDER BY CNT ASC

--8. WHICH COFFEE TYPES DO THE CUSTOMERS PREFER THE MOST? RANK THEM
SELECT COFFEE_TYPE, COUNT([ORDER ID]) CNT,
ROW_NUMBER() OVER(ORDER BY COUNT([ORDER ID]) DESC) Rnk FROM orders$ O INNER JOIN products$ P
ON O.[Product ID] = P.[Product ID]
GROUP BY COFFEE_TYPE

--9. WHICH CUSTOMERS ORDERED MORE THAN AVERAGE?
SELECT FIRST_NAME, SUR_NAME, COUNTRY, CITY, [Address Line 1], SUM(Quantity) Cnt FROM customers$ C
INNER JOIN orders$ O ON C.[Customer ID] = O.[Customer ID] WHERE Quantity > (SELECT AVG(QUANTITY) FROM orders$)
GROUP BY FIRST_NAME, SUR_NAME, COUNTRY, CITY, [Address Line 1]

--10. CALCULATE THE TOTAL AMOUNT SPENT ON EACH COFFEE TYPE BY COUNTRY IN THE YEAR 2021 ONLY
SELECT COUNTRY, COFFEE_TYPE, SUM(QUANTITY * [UNIT PRICE]) Total_Amt FROM customers$ C JOIN orders$ O
ON C.[Customer ID] = O.[Customer ID] JOIN products$ P ON O.[Product ID] = P.[Product ID]
WHERE DATE LIKE '2021%'
GROUP BY COUNTRY, COFFEE_TYPE
ORDER BY Total_Amt DESC

--11. WHICH COFFEE-ROAST TYPE DID PEOPLE APPRECIATE THE MOST IN EACH COUNTRY?
SELECT COUNTRY, ROAST_TYPE, SUM(QUANTITY) Totals FROM orders$ O JOIN products$ P
ON O.[Product ID] = P.[Product ID] JOIN customers$ C ON C.[Customer ID] = O.[Customer ID]
GROUP BY COUNTRY, ROAST_TYPE
ORDER BY Totals ASC

--12. HOW MANY OF OUR CUSTOMERS HAVE LOYALTY CARDS FROM EACH COUNTRY?
SELECT FIRST_NAME, SUR_NAME, [CUSTOMER ID], COUNTRY, [PHONE NUMBER], CITY FROM customers$ C
WHERE [LOYALTY CARD] = 'YES'
GROUP BY FIRST_NAME, SUR_NAME, [CUSTOMER ID], COUNTRY, [PHONE NUMBER], CITY

--13. GIVE ME DETAILS OF THE CUSTOMER THAT PLACED THE MOST ORDERS
SELECT FIRST_NAME, SUR_NAME, [PHONE NUMBER], COUNTRY, COUNT([ORDER ID]) Cnt FROM customers$ C
JOIN orders$ O ON C.[Customer ID] = O.[Customer ID]
GROUP BY FIRST_NAME, SUR_NAME, [PHONE NUMBER], COUNTRY
ORDER BY Cnt DESC

--14. FIND DETAILS OF THE CUSTOMER WHO PLACED THE 2ND HIGHEST ORDER?
SELECT TOP 1 SUM(QUANTITY) Tot, FIRST_NAME, SUR_NAME, [PHONE NUMBER], COUNTRY
FROM customers$ C JOIN orders$ O ON C.[Customer ID] = O.[Customer ID]
WHERE QUANTITY < (select SUM(QUANTITY) FROM orders$)
GROUP BY FIRST_NAME, SUR_NAME, [PHONE NUMBER], COUNTRY
ORDER BY SUM(QUANTITY) DESC

--15. FIND THE TOTAL AMOUNT SPENT BY ALL CUSTOMERS THAT HAVE FIRST NAMES STARTING WITH AN A
SELECT FIRST_NAME, SUR_NAME, [PHONE NUMBER], COUNTRY, SUM(QUANTITY * [UNIT PRICE]) AS Tot_Amt
FROM customers$ C JOIN orders$ O ON C.[Customer ID] = O.[Customer ID]
JOIN products$ P ON O.[Product ID] = P.[Product ID]
WHERE FIRST_NAME LIKE 'A%'
GROUP BY FIRST_NAME, SUR_NAME, [PHONE NUMBER], COUNTRY
ORDER BY Tot_Amt DESC

--16. CALCULATE THE TOTAL COFFEE ORDERS PLACED
SELECT SUM(QUANTITY) AS QTY FROM orders$

SELECT * FROM customers$

SELECT * FROM orders$

SELECT * FROM products$